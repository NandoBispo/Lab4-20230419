---
title: "Banco de dados: Boston House Prices"
author: "Fernado Bispo, Jeff Caponero"
format:
    pdf:
      toc: true
      toc-title: Sumário
      colorlinks: true
      documentclass: report
      papersize: letter
      number-sections: false
      geometry:
        - top=30mm
        - left=30mm
        - right=20mm
        - bottom=20mm
        - heightrounded
      fig-pos: "H"
      fig-align: center
      lang: pt-BR
      fontfamily: libertinus
      include-in-header:
      - text: |
          \usepackage{caption}
          \usepackage{xcolor}
          \usepackage{indentfirst}
          \captionsetup[table]{name=Tabela}
---


```{r pacotes&dados}
#| echo: false
#| warning: false


# PACOTES ----

if (!require(pacman))
  install.packages("pacman")
library(pacman)

pacman::p_load(tidyverse,  janitor, stargazer,  sjmisc, summarytools,
               kableExtra, moments, ggpubr, formattable, gridExtra, 
               glue, corrplot, sessioninfo, readxl, writexl, ggthemes,
               patchwork,  plotly, lmtest, olsrr, gglm, ggplot2,
               tidymodels, GGally, skimr)

dados <- read.csv("boston.csv")

## Arrumação ----
dados <- dados|>
  janitor::clean_names()

dados <- dados|>
  mutate(
    chas = forcats::as_factor(chas))
```


# Introdução

A busca pela moradia própria é o desejo da grande maioria das pessoas, contudo a conquista desse bem nos grandes centros não é tarefa fácil. Levando isso em consideração a procura por imóveis na região metropolitana torna-se uma opção viável economicamente, mesmo havendo penalizações no que diz respeito a distância e congestionamentos.

O objetivo deste relatório é trazer a luz as análises e conclusões acerca da utilização das técnicas de regressão linear a fim de determinar o preço das casas em Boston, baseado nos dados fornecidos pelo conjunto de dados obtido. Neste primeiro momento, em que se utilizará a regressão linear simples, se buscará determinar uma função que descreva a relação entre o Valor Médio dos imóveis e o Percentual da população de "classe baixa".

Composto por 506 observações e 14 variáveis, o conjunto de dados, publicado no *Jornal of Environmental Economics & Management*, vol.5, 81-102, 1978.t, traz inúmeras características que servirão de parâmetros para resolução do seguinte questionamento: O valor médio dos imóveis é influenciado pelas diversas características externas observadas?


# Metodologia

## Sobre o conjunto de dados

Os dados de preços de 506 casas em Boston, publicados em Harrison, D. and Rubinfeld, D.L. [*'Hedonic prices and the demand for clean air'*](https://www.researchgate.net/profile/Daniel-Rubinfeld/publication/4974606_Hedonic_housing_prices_and_the_demand_for_clean_air/links/5c38ce85458515a4c71e3a64/Hedonic-housing-prices-and-the-demand-for-clean-air.pdf), J. Environ. Economics & Management, vol.5, 81-102, 1978.

Usado em Belsley, Kuh & Welsch, [*'Regression diagnostics: identifying influential data and sources of collinearity.*](https://www.wiley.com/en-us/Regression+Diagnostics%3A+Identifying+Influential+Data+and+Sources+of+Collinearity-p-9780471691174) New York: Wiley 1980.
Os dados podem ser acessados na plataforma para aprendizado de ciência de dados [Kaggle](https://www.kaggle.com/datasets/fedesoriano/the-boston-houseprice-data) através do link:

<https://www.kaggle.com/datasets/fedesoriano/the-boston-houseprice-data>.  

### Variáveis a serem analisadas

As amostras contêm 13 atributos de casas em diferentes locais nos subúrbios de Boston no final dos anos 1970. Os objetivos são os valores médios das casas em um local (em k$). As variáveis são descritas a seguir:

1. CRIM: Índice de criminalidade per capita por bairro.
2. ZN: Proporção de terreno residencial zoneado para lotes acima de 25.000 sq.ft.
3. INDUS: Proporção de hectares de negócios não varejistas por bairro.
4. CHAS: Variável fictícia que representa imóveis próximos a margem do rio Charles (1 se o trecho margeia o rio; 0 caso contrário).
5. NOX: Concentração de óxidos nítricos (partes por 10 milhões).
6. RM: Número médio de cômodos por habitação.
7. AGE: Proporção de unidades ocupadas pelo proprietário construídas antes de 1940.
8. DIS: Distâncias ponderadas para cinco centros de emprego de Boston.
9. RAD: Índice de acessibilidade às rodovias radiais.
10. TAX: Taxa de imposto de propriedade de valor total por $10.000.
11. PTRATIO: Proporção aluno-professor por bairro.
12. B: O resultado da equação $B=1000(Bk - 0,63)^2$ onde $Bk$ é a proporção de negros por bairro.
13. LSTAT: % da população de "classe baixa".
<!-- 14. MEDV: Valor médio de residências ocupadas pelo proprietário em -->
<!-- US$1.000. -->

### Sobre a interpretabilidade de algumas variáveis

Existem variáveis que em virtude da sua natureza e da falta de um dicionário, inviabilizam a interpretação. Ressalto também que o conjunto de dados tem um problema ético, os autores deste conjunto de dados incluíram uma variável, "**B**", que pode parecer assumir que a auto-segregação racial influencia os preços das casas e portanto será excluída das análises, sendo estas:

- ZN: Proporção de terreno residencial zoneada para lotes acima de 25.000 sq.ft.
- RAD: Índice de acessibilidade às rodovias radiais. 
- B: O resultado da equação $B=1000(Bk - 0,63)^2$ onde $Bk$ é a proporção de negros por bairro.

# Resultados

## Análise Descritiva dos Dados

<font size=4>
Iniciando a análise das variáveis contidas no conjunto de dados foi construída a Tabela 1 com a sumarização das variáveis em análise, a fim de identificar o comportamento das variáveis por meio das métricas de posição e dispersão.
</font>

```{r tab1:medidas_resumo}
#| echo: false
#| warning: false

# Medidas Resumo ----
summarytools::st_options(lang = "pt")

dados|>
  select(-b, - rad, -zn)|>
  rename(
    "AGE" = age, "CRIM" = crim, "DIS" = dis, "INDUS" = indus,
    "LSTAT" = lstat, "NOX" = nox, "PTRATIO" = ptratio,
    "RM" = rm, "TAX" = tax, "MEDV" = medv
  )|>
  summarytools::descr(
    stats = c("min", "q1", "med", "mean","q3", "max",  "sd", "cv", "Skewness", "Kurtosis"),
    justify = "c",
    style = "rmarkdown",
    transpose = T
  )|>
    kbl(
    caption = "Medidas Resumo dos dados",
    digits = 2,
    format.args=list(big.mark=".", decimal.mark=","),
    align = "c", row.names = T, booktabs = T
  )|>
  kable_styling(
    full_width = F, position = 'center', 
    latex_options = c("striped", "HOLD_position", "scale_down", "repeat_header")
  )|>
  column_spec(1, bold = F
              )|>
  footnote(
    general = "StatLib - Carnegie Mellon University",
    general_title = "Fonte:",
    footnote_as_chunk = T
    )|>
  footnote(
    number = c(
      "AGE: Proporção de unidades próprias construídas antes de 1940.",
      "CRIM: Índice de criminalidade per capita por bairro.",
      "DIS: Distâncias ponderadas para cinco centros de emprego de Boston.",
      "INDUS: Proporção de hectares de negócios não varejistas por bairro.",
      'LSTAT: Percentual da população de "classe baixa".',
      "MEDV: Valor médio de residências ocupadas pelo proprietário.",
      "NOX: Concentração de óxidos nítricos (partes por 10 milhões).",
      "PTRATIO: Proporção aluno-professor por bairro.",
      "RM: Número médio de cômodos por habitação.",
      "TAX: Valor total do imposto predial por $10.000."),
    number_title = "Legenda:",
    footnote_as_chunk = F
    )|>
  # kableExtra::add_footnote(c("Legenda:"), notation = "none")|>
  # kableExtra::add_footnote(c(
  #   "AGE: Proporção de unidades próprias construídas antes de 1940.",
  #   "CRIM: Índice de criminalidade per capita por bairro.",
  #   "DIS: Distâncias ponderadas para cinco centros de emprego de Boston.",
  #   "INDUS: Proporção de hectares de negócios não varejistas por bairro.",
  #   'LSTAT: Percentual da população de "classe baixa".',
  #   "MEDV: Valor médio de residências ocupadas pelo proprietário.",
  #   "NOX: Concentração de óxidos nítricos (partes por 10 milhões).",
  #   "PTRATIO: Proporção aluno-professor por bairro.",
  #   "RM: Número médio de cômodos por habitação.",
  #   "TAX: Valor total do imposto predial por $10.000."),
  # notation = "none"
  # )|>
  kable_material()

```

Analisando a Tabela 1 é possível identificar a presença de pontos atípicos para a variável **crim**, sendo esta a variável que mais se destaca pelos indicadores obtidos, gerando assim uma grande variabilidade, confirmada pelo Coeficiente de Variação - CV, sendo esta medida que avalia a dispersão dos dados em relação a média, além de verificar um elevado Coeficiente de Assimetria Positiva, indicando que a maioria dos dados são menores que a média e um comportamento Leptocúrtico, com base no Coeficiente de Curtose, ou seja, os dados possuem um comportamento mais alongado.

A Figura 1 traz os Histogramas das variáveis a fim de tentar identificar o comportamento das variáveis e uma possível associação a algum modelo de distribuição

```{r fig1:Histograma}
#| echo: false
#| warning: false
#| fig-height: 9
#| fig-width: 7

# Histograma ----
{
## g1 age ----
g1 <- dados|>
  ggplot() +
  aes(x = age) +
  geom_histogram(
    aes(y = ..density..),
    bins = 40,
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Unidades constuídas antes \nde 1940",
    x = "Proporção",
    y = "Densidade"
  )

## g2 crim ----
g2 <- dados|>
  ggplot() +
  aes(x = crim) +
  geom_histogram(
    aes(y = ..density..),
    fill = "lightblue",
    colour = "darkblue",
    # binwidth = 2
    bins = 45
    ) +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Índice de Criminalidade",
    x = "Índice",
    y = "Densidade"
  )

## g3 dis ----
g3 <- dados|>
  ggplot() +
  aes(x = dis) +
  geom_histogram(
    aes(y = ..density..),
    bins = 45,
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_x_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Distância para cinco centros \nde emprego.",
    x = "Distâncias Ponderadas",
    y = "Densidade"
  )

## g4 indus ----
g4 <- dados|>
  ggplot() +
  aes(x = indus) +
  geom_histogram(
    aes(y = ..density..),
    bins = 40,
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Negócios não varejistas \npor bairro",
    x = "Proporção de hectares ocupados",
    y = "Densidade"
  )

## g5 lstat ----
g5 <- dados|>
  ggplot() +
  aes(x = lstat) +
  geom_histogram(
    aes(y = ..density..),
    bins = 40,
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = 'População de "classe baixa"',
    x = 'Percentual',
    y = "Densidade"
  )

## g6 medv ----
g6 <- dados|>
  ggplot() +
  aes(x = medv) +
  geom_histogram(
    aes(y = ..density..),
    bins = 35,
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Valor médio de residências ocupadas",
    x = "Valor Médio",
    y = "Densidade"
  )
## g7 nox ----
g7 <- dados|>
  ggplot() +
  aes(x = nox) +
  geom_histogram(
    aes(y = ..density..),
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Concentração de Óxidos \nNitricos (NO)",
    x = "Partes por 10 milhões",
    y = "Densidade"
  )

## g8 ptratio ----
g8 <- dados|>
  ggplot() +
  aes(x = ptratio) +
  geom_histogram(
    aes(y = ..density..),
    bins = 30,
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_x_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Aluno/Professor por bairro",
    x = "Proporção",
    y = "Densidade"
  )

## g9 rm ----
g9 <- dados|>
  ggplot() +
  aes(x = rm) +
  geom_histogram(
    aes(y = ..density..),
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Número médio de cômodos por habitação",
    x = "Quantidade",
    y = "Densidade"
  )

## g10 tax ----
g10 <- dados|>
  ggplot() +
  aes(x = tax) +
  geom_histogram(
    aes(y = ..density..),
    bins = 35,
    fill = "lightblue",
    colour = "darkblue") +
  geom_density(
    alpha = 0.2,
    fill = "blue",
    colour = "blue") +
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    )) +
  labs(
    title = "Taxa de imposto predial",
    x = "Valor por $10.000",
    y = "Densidade"
  )

g1 + g2 + g3 + g4 + g5 + g6 + g7 + g8 + g9 + g10  +  
  plot_layout(ncol = 3) + 
  plot_annotation(
    title = "Figura 1: Histogramas das variáveis em análise.",
    caption = "Fonte: StatLib - Carnegie Mellon University",
    tag_levels = c("A", "1"), tag_prefix = "Sub Fig. ", tag_sep = ".",
    tag_suffix = ":") &
  theme_minimal(base_size = 7.5) &
  theme(
    plot.tag.position = c(0, 1),
    plot.tag = element_text(size = 5.5, hjust = 0, vjust = -0.4))
}
```


A Figura 2 traz os Gráficos de Caixa (*BoxPlot*) das variáveis em análise com o intuito de identificar a presença de pontos influentes, bem como a variabilidade das variáveis por meio da análise visual.


```{r fig2:BoxPlot}
#| echo: false
#| warning: false
#| fig-height: 9
#| fig-width: 7


# BoxPlot ----
{
## b1 age ----
b1 <- dados|>
  mutate(chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = age)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Unidades constuídas antes \nde 1940",
    x = "Posição",
    y = "Proporção antes de 1940"
  )

## b2 crim ----
b2 <- dados|>
  mutate(
    chas = lvls_revalue(chas, c("Na Margem", "Afastado"))
  )|>
  ggplot(aes(x = chas, y = crim)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Índice de Criminalidade",
    x = "Posição",
    y = "Índice"
  )

## b3 dis ----
b3 <- dados|>
  mutate( chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = dis)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Distância para cinco centros \nde emprego.",
    x = "Posição",
    y = "Distâncias Ponderadas"
  ) +
  scale_y_continuous(
    labels = scales::number_format(
      dig.mark = ".",
      decimal.mark = ","))
      
## b4 indus ----
b4 <- dados|>
  mutate(chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = indus)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Negócios não varejistas \npor bairro",
    x = "Proporção de hectares ocupados",
    y = "Densidade"
  )

## b5 lstat ----
b5 <- dados|>
  mutate(chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = lstat)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = 'População de "classe baixa"',
    x = "Posição",
    y = "Percentual"
  )

## b6 medv ----
b6 <- dados|>
  mutate(chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = medv)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Valor médio de residências \nocupadas",
    x = "Posição",
    y = "Valor médio"
  )

## b7 nox ----
b7 <- dados|>
  mutate(chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = nox)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Concentração de Óxidos \nNitricos (NO)",
    x = "Posição",
    y = "Partes por 10 milhões"
  ) +
  scale_y_continuous(
    labels = scales::number_format(
      dig.mark = ".",
      decimal.mark = ","))

## b8 ptratio ----
b8 <- dados|>
  mutate(chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = ptratio)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Aluno/Professor por bairro",
    x = "Posição",
    y = "Proporção"
  ) +
  scale_y_continuous(
    labels = scales::number_format(
      dig.mark = ".",
      decimal.mark = ","))

## b9 rm ----
b9 <- dados|>
  mutate(chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = rm)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Número médio de cômodos por \nhabitação",
    x = "Posição",
    y = "Quantidade"
  )

## b10 tax ---- 
b10 <- dados|>
  mutate(chas = lvls_revalue(chas, c("Na Margem", "Afastado")))|>
  ggplot(aes(x = chas, y = tax)) +
  geom_boxplot(col="darkblue", fill="skyblue", alpha = 0.5)+
  labs(
    title = "Taxa de imposto predial",
    x = "Posição",
    y = "Valor por $10.000"
  )

b1 + b2 + b3 + b4 + b5 + b6 + b7 + b8 + b9 + b10  +  
  plot_layout(ncol = 3) + 
  plot_annotation(
    title = "Figura 2: BoxPlot das variáveis em análise.",
    caption = "Fonte: StatLib - Carnegie Mellon University",
    # theme = theme_minimal(plot.title = element_text(size = 10)),
    tag_levels = c("A", "1"), tag_prefix = "Sub Fig. ", tag_sep = ".",
    tag_suffix = ":") &
  theme_minimal(base_size = 7.5) &
  theme(
    plot.tag.position = c(0, 1),
    plot.tag = element_text(size = 5.5, hjust = 0, vjust = -0.4))
}

```

Corroborando com a identificação feita com base na Tabela 1, a variável que avalia o **Índice de Criminalidade** possui uma grande quantidade de valores atípicos principalmente para a região próxima a margem do rio Charles.

## Análise Correlacional

A Figura 3 traz os gráficos de dispersão das variáveis, tendo como variável resposta o Valor Médio dos Imóveis por \$1.000 e as demais variáveis como explicativas, a fim de se identificar a possível existência de correlação entre elas, sendo calculado e descrito o Coeficiente de Correlação de Pearson ($\widehat{\rho}$) de cada gráfico, a fim de se ter numericamente a força da relação entre a variável resposta com as demais variáveis do conjunto de dados.


```{r fig3:Dispersao}
#| echo: false
#| warning: false
#| fig-height: 8
#| fig-width: 7

# Dispersão ----
{
  ## d1 age ----
  d1 <- dados|>
    ggplot(aes(y = medv, x = age, color = age)) +
    geom_point()+
    labs(
      title = "Unidades constuídas antes de \n1940",
      y = 'Valor Médio (por $1.000)',
      x = 'Proporção antes de 1940'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 5, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)+
    scale_y_continuous(
      labels = scales::number_format(
        big.mark = ".",
        decimal.mark = ","
      ))
  
  ## d2 crim ----
  d2 <- dados |>
    ggplot(aes(
      y = medv, 
      x = crim, color = crim)) +
    geom_point()+
    labs(
      title = 'Índice de Criminalidade',
      y = 'Valor Médio (por $1.000)',
      x = 'Índice'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 50, label.y = 50, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)

  ## d3 dis ----
  d3 <- dados |>
    ggplot(aes(
      y = medv, 
      x = dis, color = dis)) +
    geom_point()+
    labs(
      title = "Distância para cinco centros de \nemprego.",
      y = 'Valor Médio (por $1.000)',
      x = 'Distâncias Ponderadas'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 9, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)+
    scale_x_continuous(
      labels = scales::number_format(
        big.mark = ".",
        decimal.mark = ","
      ))
  
  ## d4 indus ----
  d4 <- dados |>
    ggplot(aes(
      y = medv, 
      x = indus, color = indus)) +
    geom_point()+
    labs(
      title = "Negócios não varejistas por \nbairro",
      y = 'Valor Médio (por $1.000)',
      x = 'Hectares Ocupados'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 1.5, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)
    # geom_smooth(method=lm, se=TRUE)
  
  ## d5 lstat ----
  d5 <- dados |>
    ggplot(aes(
      y = medv, 
      x = lstat, color = lstat)) +
    geom_point()+
    labs(
      title = 'População de "classe baixa"',
      y = 'Valor Médio (por $1.000)',
      x = 'Percentual'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 25, label.y = 47.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)

  ## d6 nox ----
  d6 <- dados |>
    ggplot(aes(
      y = medv, 
      x = nox, color = nox)) +
    geom_point()+
    labs(
      title = "Concentração de Óxidos \nNitricos (NO)",
      y = 'Valor Médio (por $1.000)',
      x = 'Partes por 10 milhões'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 0.75, label.y = 47.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)+
    scale_x_continuous(
      labels = scales::number_format(
        big.mark = ".",
        decimal.mark = ","
      ))
  
  ## d7 ptratio ----
  d7 <- dados |>
    ggplot(aes(
      y = medv, 
      x = ptratio, color = ptratio)) +
    geom_point()+
    labs(
      title = "Aluno/Professor por bairro",
      y = 'Valor Médio (por $1.000)',
      x = 'Proporção'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 13, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)+
    scale_x_continuous(
      labels = scales::number_format(
        big.mark = ".",
        decimal.mark = ","
      ))
  
  ## d8 rm ----
  d8 <- dados |>
    ggplot(aes(
      y = medv, 
      x = rm, color = rm)) +
    geom_point()+
    labs(
      title = "Número médio de cômodos por \nhabitação",
      y = 'Valor Médio (por $1.000)',
      x = 'Quantidade'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 3.7, label.y = 47.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)
  
  ## d9 tax ----
  d9 <- dados |>
    ggplot(aes(
      x = tax, y = medv, color = tax)) +
    geom_point()+
    labs(
      title = "Taxa de imposto predial",
      y = 'Valor Médio (por $1.000)',
      x = 'Valor por $10.000'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 200, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)

  d1 + d2 + d3 + d4 + d5 + d6 + d7 + d8 + d9 +  
    plot_layout(ncol = 3) + 
    plot_annotation(
      title = "Figura 3: Relação entre o Valor médio dos imóveis e demais medições",
      caption = "Fonte: StatLib - Carnegie Mellon University\nValor do Coeficiente de Correlação de Pearson em vermelho",
      tag_levels = c("A", "1"), tag_prefix = "Sub Fig. ", tag_sep = ".",
      tag_suffix = ":") &
    theme_minimal(base_size = 7.5) &
    theme(
      legend.position = "none",
      plot.tag.position = c(0, 1),
      plot.tag = element_text(size = 5.5, hjust = 0, vjust = -0.4))

}
```


Após análise da Figura 3 é constatado tanto pelo comportamento dos dados quanto pelo valor do coeficiente de correlação que as variáveis que apresentam maior correlação são as variáveis que representam o **Percentual da população de ”classe baixa”** e o **Número médio de cômodos por habitação**, ainda assim segue a Figura 4 com a Reta de Regressão para todas as variáveis.


```{r fig4:regressao}
#| echo: false
#| warning: false
#| fig-height: 8
#| fig-width: 7

# Dispersão ----
{
  ## d1 age ----
  d1 <- dados|>
    ggplot(aes(y = medv, x = age, color = age)) +
    geom_point()+
    labs(
      title = "Unidades constuídas antes de \n1940",
      y = 'Valor Médio (por $1.000)',
      x = 'Proporção antes de 1940'
    )+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 5, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)+
    scale_y_continuous(
      labels = scales::number_format(
        big.mark = ".",
        decimal.mark = ","
      ))+
    geom_smooth(method=lm, se=TRUE)
  
  ## d2 crim ----
  d2 <- dados |>
    ggplot(aes(
      y = medv, 
      x = crim, color = crim)) +
    geom_point()+
    labs(
      title = 'Índice de Criminalidade',
      y = 'Valor Médio (por $1.000)',
      x = 'Índice'
    )+
    geom_smooth(method=lm, se=TRUE)+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 50, label.y = 50, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)

  ## d3 dis ----
  d3 <- dados |>
    ggplot(aes(
      y = medv, 
      x = dis, color = dis)) +
    geom_point()+
    labs(
      title = "Distância para cinco centros de \nemprego.",
      y = 'Valor Médio (por $1.000)',
      x = 'Distâncias Ponderadas'
    )+
    geom_smooth(method=lm, se=TRUE)+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 9, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)+
    scale_x_continuous(
      labels = scales::number_format(
        big.mark = ".",
        decimal.mark = ","
      ))
  
  ## d4 indus ----
  d4 <- dados |>
    ggplot(aes(
      y = medv, 
      x = indus, color = indus)) +
    geom_point()+
    labs(
      title = "Negócios não varejistas por \nbairro",
      y = 'Valor Médio (por $1.000)',
      x = 'Hectares Ocupados'
    )+
    geom_smooth(method=lm, se=TRUE)+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 1.5, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)
    # geom_smooth(method=lm, se=TRUE)
  
  ## d5 lstat ----
  d5 <- dados |>
    ggplot(aes(
      y = medv, 
      x = lstat, color = lstat)) +
    geom_point()+
    labs(
      title = 'População de "classe baixa"',
      y = 'Valor Médio (por $1.000)',
      x = 'Percentual'
    )+
    geom_smooth(method=lm, se=TRUE)+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 25, label.y = 47.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)

  ## d6 nox ----
  d6 <- dados |>
    ggplot(aes(
      y = medv, 
      x = nox, color = nox)) +
    geom_point()+
    labs(
      title = "Concentração de Óxidos \nNitricos (NO)",
      y = 'Valor Médio (por $1.000)',
      x = 'Partes por 10 milhões'
    )+
    geom_smooth(method=lm, se=TRUE)+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 0.75, label.y = 47.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)+
    scale_x_continuous(
      labels = scales::number_format(
        big.mark = ".",
        decimal.mark = ","
      ))
  
  ## d7 ptratio ----
  d7 <- dados |>
    ggplot(aes(
      y = medv, 
      x = ptratio, color = ptratio)) +
    geom_point()+
    labs(
      title = "Aluno/Professor por bairro",
      y = 'Valor Médio (por $1.000)',
      x = 'Proporção'
    )+
    geom_smooth(method=lm, se=TRUE)+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 13, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)+
    scale_x_continuous(
      labels = scales::number_format(
        big.mark = ".",
        decimal.mark = ","
      ))
  
  ## d8 rm ----
  d8 <- dados |>
    ggplot(aes(
      y = medv, 
      x = rm, color = rm)) +
    geom_point()+
    labs(
      title = "Número médio de cômodos por \nhabitação",
      y = 'Valor Médio (por $1.000)',
      x = 'Quantidade'
    )+
    geom_smooth(method=lm, se=TRUE)+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 3.7, label.y = 47.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)
  
  ## d9 tax ----
  d9 <- dados |>
    ggplot(aes(
      x = tax, y = medv, color = tax)) +
    geom_point()+
    labs(
      title = "Taxa de imposto predial",
      y = 'Valor Médio (por $1.000)',
      x = 'Valor por $10.000'
    )+
    geom_smooth(method=lm, se=TRUE)+
    ggpubr::stat_cor(
      aes(label = ..r.label..),
      cor.coef.name = c("rho"),
      label.sep = "; ", geom = "text",
      color="red", method = "pearson", 
      label.x = 200, label.y = 7.5, show.legend = F,
      p.accuracy = 0.001, r.accuracy = 0.0001,
      size = 2)

  d1 + d2 + d3 + d4 + d5 + d6 + d7 + d8 + d9 +  
    plot_layout(ncol = 3) + 
    plot_annotation(
      title = "Figura 4: Reta de regressão ajustada entre o Valor médio dos imóveis e demais medições",
      caption = "Fonte: StatLib - Carnegie Mellon University\nValor do Coeficiente de Correlação de Pearson em vermelho",
      tag_levels = c("A", "1"), tag_prefix = "Sub Fig. ", tag_sep = ".",
      tag_suffix = ":") &
    theme_minimal(base_size = 7.5) &
    theme(
      legend.position = "none",
      plot.tag.position = c(0, 1),
      plot.tag = element_text(size = 5.5, hjust = 0, vjust = -0.4))

}
```



<!-- Levando em consideração que o objetivo inicial é verificar a influência do Percentual da população de ”classe baixa” no Valor Médio dos Imóveis localizados na periferia de Boston, Segue a Figura 4 com o diagrama de dispersão, a fim de trazer uma possível relação visual entre as variáveis. -->



```{r fig4:Dispersao2}
#| echo: false
#| warning: false


# 
# dados |>
#   ggplot(aes(
#       y = medv, 
#       x = crim, color = crim)) +
#   geom_point()+
#   labs(
#     title = 'Figura 3: Gráfico de dispersão entre Valor Médio dos Imóveis \ne o Índice de Criminalidade',
#     y = 'Valor Médio (por $1.000)',
#     x = 'Índice de Criminalidade'
#   )+
#   theme_minimal()+
#   theme(legend.position = "none")
```


Analisando a Figura 4 é possível identificar que o **Valor médio dos imóveis** se concentra em regiões em que o **Percentual da população de “classe baixa”** (Sub.Fig E) é baixo, como esperado, demonstrando uma relação linear negativa com um Coeficiente de Correlação de Pearson ($\widehat{\rho}$) de `r round(cor(dados$medv, dados$lstat), 4)` corroborando com a existência da correlação negativa entre as variáveis confirmada através do teste de hipóteses.


```{r ajuste_modelo}
#| echo: false
#| warning: false

# Ajuste do Modelo ----

mCrim <- lm(dados$medv~dados$crim)
mIndus <- lm(dados$medv~dados$indus)
mNox <- lm(dados$medv~dados$nox)
mRm <- lm(dados$medv~dados$rm)
mAge <- lm(dados$medv~dados$age)
mDis <- lm(dados$medv~dados$dis)
mTax <- lm(dados$medv~dados$tax)
mPtratio <- lm(dados$medv~dados$ptratio)
mLstat <- lm(dados$medv~dados$lstat)

# Calculando e armazenando o beta0 e erro padrão0
resultados <-  cbind(
  summary(mCrim)$coefficients[1,],
  summary(mIndus)$coefficients[1,],
  summary(mNox)$coefficients[1,],
  summary(mRm)$coefficients[1,],
  summary(mAge)$coefficients[1,],
  summary(mDis)$coefficients[1,],
  summary(mTax)$coefficients[1,],
  summary(mPtratio)$coefficients[1,],
  summary(mLstat)$coefficients[1,])

# Removendo testes
resultados <-  resultados[-c(3,4),]

# Calculando e armazenando o beta1 e erro padrão1
aux <-  cbind(
  summary(mCrim)$coefficients[2,],
  summary(mIndus)$coefficients[2,],
  summary(mNox)$coefficients[2,],
  summary(mRm)$coefficients[2,],
  summary(mAge)$coefficients[2,],
  summary(mDis)$coefficients[2,],
  summary(mTax)$coefficients[2,],
  summary(mPtratio)$coefficients[2,],
  summary(mLstat)$coefficients[2,])

# Mantém apenas beta1 e o erro padrão
aux <- aux[-c(3,4),]

resultados <- rbind(resultados, aux)

# Função para calcular o p-valor
lmp <- function (modelobject) {
  if (class(modelobject) != "lm") stop("Not an object of class 'lm' ")
  f <- summary(modelobject)$fstatistic
  p <- pf(f[1],f[2],f[3],lower.tail=F)
  attributes(p) <- NULL
  return(p)
}

# Calculando e armazenando o p-valor
aux <- cbind(
  lmp(mCrim), lmp(mIndus),
  lmp(mNox), lmp(mRm),
  lmp(mAge), lmp(mDis),
  lmp(mTax),lmp(mPtratio),lmp(mLstat))

resultados <- rbind(resultados, aux)

# Calculando e armazenando o Coeficiente de Correlação
aux <-  cbind(
  summary(mCrim)$r.squared,
  summary(mIndus)$r.squared,
  summary(mNox)$r.squared,
  summary(mRm)$r.squared,
  summary(mAge)$r.squared,
  summary(mDis)$r.squared,
  summary(mTax)$r.squared,
  summary(mPtratio)$r.squared,
  summary(mLstat)$r.squared)

resultados <- rbind(resultados, aux)

# Inserindo o nome das variáveis (colunas)
colnames(resultados) <- c("CRIM", "INDUS", "NOX", "RM", "AGE", "DIS", "TAX", "PTRATIO", "LSTAT")

# Inserindo o nome das linhas
rownames(resultados) <- c("$\\beta_0$", "$\\sigma_0$", "$\\beta_1$", "$\\sigma_1$", "p-valor", "$\\hat \\rho$")

```

Após o ajuste dos modelos exibidos na Figura 4, foi elaborada a Tabela 2 com os respectivos valores das regressões calculadas entre valor médio dos imóveis e demais medições.

```{r tab2:ajuste_modelo}
#| echo: false
#| warning: false

resultados|>
  kbl(
    caption = "Valores dos modelos de regressão linear simples.",
    format.args=list(big.mark=".", decimal.mark=","),
    digits = 3, align = "c", row.names = T, booktabs = T,
    # format = "latex", 
    escape = FALSE,
  )|>
  kable_styling(
    full_width = F, position = 'center', 
    latex_options = c("striped", "HOLD_position", "scale_down", "repeat_header")
  )|>
  column_spec(1, bold = F
  )|>
  footnote(
    general = "StatLib - Carnegie Mellon University",
    general_title = "Fonte:",
    footnote_as_chunk = T
  )|>
  kableExtra::add_footnote(c("Legenda:"), notation = "none")|>
  kableExtra::add_footnote(c(
    "AGE: Proporção de unidades próprias construídas antes de 1940.",
    "CRIM: Índice de criminalidade per capita por bairro.",
    "DIS: Distâncias ponderadas para cinco centros de emprego de Boston.",
    "INDUS: Proporção de hectares de negócios não varejistas por bairro.",
    'LSTAT: Percentual da população de "classe baixa".',
    "NOX: Concentração de óxidos nítricos (partes por 10 milhões).",
    "PTRATIO: Proporção aluno-professor por bairro.",
    "RM: Número médio de cômodos por habitação.",
    "TAX: Valor total do imposto predial por $10.000."),
    notation = "none"
  )|>
  kable_material()
```

Mesmo com os modelos calculados, se faz necessário a avaliação da bondade dos modelos.


```{r}
#| echo: false
#| warning: false
#| tbl-colum: page

res <- mLstat$residuals

d1<- dados |>
  ggplot(aes(
    x = res, 
    y = mLstat$effects)) +
  geom_point(colour="tomato")+
  labs(
    title = '',
    y = 'Resíduos',
    x = 'Valor Médio Ajustado'
  )+
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    ))

d2 <- dados |>
  ggplot(aes(sample=res))+
    labs(
    title = '',
    y = 'Resíduos Studentizados',
    x = 'Quantis t-Student'
  )+
  scale_y_continuous(
    labels = scales::number_format(
      big.mark = ".",
      decimal.mark = ","
    ))+
  stat_qq(colour="tomato") + stat_qq_line(col="blue") 
  


d1+d2 + plot_annotation(
  title = "Figura 5: Análise de resíduos do modelo de regressão da classe social com \n valor dos imóveis.") &
  theme_bw(base_size = 8) &
  theme(
    legend.position = "none",
    plot.tag.position = c(0, 1),
    plot.tag = element_text(size = 8, hjust = 0, vjust = 0)
  )
```




### Testes de diagnóstico

Pode-se ainda utilizar um conjunto de testes de diagnóstico para confirmar este novo teste de significância.
Como:

- Teste de Kolmogorov-Smirnov
- Teste de Shapiro-Wilks
- Teste de Goldfeld-Quandt
- Teste de Breush-Pagan
- Teste de Park
- Teste F para linearidade
- Teste para avaliação da independência dos resíduos


##### Teste de Kolmogorov-Smirnov

```{r}
#| warning: false
#| eval: true
#| results: false
#| echo: false
t.ks = ks.test(res, "pnorm", mean(res), sd(res))
```

Avalia o grau de concordância entre a distribuição de um conjunto de valores observados e determinada distribuição teórica. Consiste em comparar a distribuição de frequência acumulada da distribuição teórica com aquela observada. Realizado o teste obteve-se um p-valor de aproximadamente `r round(t.ks[[2]][1],3)`, o que inviabiliza rejeitar a hipótese de que haja normalidade entre os dados, com um grau de confiabilidade minimamente razoável.

##### Teste de Shapiro-Wilks

```{r}
#| warning: false
#| eval: true
#| results: false
#| echo: false

t.sw = shapiro.test(res)

```

O teste de Shapiro-Wilks é um procedimento alternativo ao teste de Kolmogorov-Smirnov para avaliar normalidade.
Realizado o teste obteve-se um p-valor de aproximadamente `r round(t.sw[[2]][1],3)`, o que, semelhantemente, inviabiliza rejeitar a hipótese de que haja normalidade entre os dados, com um grau de confiabilidade minimamente razoável.

##### Teste de Goldfeld-Quandt

```{r}
#| warning: false
#| eval: true
#| results: false
#| echo: false

t.gq = gqtest(mLstat)

```

Esse teste envolve o ajuste de dois modelos de regressão, separando-se as observações das duas extremidades da distribuição da variável dependente.
Realizado o teste obteve-se um p-valor de aproximadamente `r round(t.gq[[5]][1],3)`, o que demanda rejeitar a hipótese de que haja homocedasticidade entre os dados, com um grau de confiabilidade de 95%. Entretanto, como o p-valor obtido é próximo do necessário para a rejeição da hipotese nula, cabe um novo teste para a confirmação do resultado obtido.

##### Teste de Breush-Pagan

```{r}
#| warning: false
#| eval: true
#| results: false
#| echo: false

t.bp = bptest(mLstat, studentize = FALSE)
```

Esse teste é baseado no ajuste de um modelo de regressão em que a variável dependente é definida pelos resíduos do modelo de interesse.
Se grande parte da variabilidade dos resíduos não é explicada pelo modelo, então rejeita-se a hipótese de homocedasticidade.
Realizado o teste obteve-se um p-valor de aproximadamente `r round(t.bp[[4]][1],3)`, desta foram deve-se rejeitar a hipótese de que haja homocedasticidade entre os dados, com um grau de confiabilidade de 95%.

##### Teste de Park

```{r}
#| warning: false
#| eval: true
#| results: false
#| echo: false
res2 <- res^2
t.p = summary(lm(res2 ~ dados$lstat))
```

Esse teste é baseado no ajuste de um modelo de regressão em que a variável dependente é definida pelos quadrados dos resíduos do modelo de interesse.
Nesse caso, se $\beta_1$ diferir significativamente de zero, rejeita-se a hipótese de homocedasticidade.
O valor de $\beta_1$ obtido no teste foi de `r round(t.p[[4]][2],3)` com p-valor de aproximadamente `r round(t.p[[4]][8],3)`.
Por esse teste não se deve rejeitar a hipótese de homocedasticidade, com confiabilidade de 95%.

##### Teste F para linearidade

```{r}
#| warning: false
#| eval: true
#| results: false
#| echo: false
m_kmedias <- lm(dados$medv ~ factor(dados$lstat))
t.fl = anova(mLstat, m_kmedias)
```

O teste da falta de ajuste permite testar formalmente a adequação do ajuste do modelo de regressão.
Neste ponto assume-se que os pressupostos de normalidade, variância constante e independência são satisfeitos, como demosntrado pelos testes realizados. A ideia central para testar a linearidade é decompor SQRes em duas partes: erro puro e falta de ajuste que vão contribuir para a definição da estatística de teste F.
Realizado o teste obteve-se um valore de p-valor igual a `r round(t.fl[[6]][2],3)`, o que demanda a rejeição da hipótese que há uma relação linear entre as variáveis. 


##### Teste para avaliação da independência dos resíduos

```{r}
#| warning: false
#| eval: true
#| results: false
#| echo: false
t.dw = dwtest(mLstat)
```

Tendo em vista, o resultado obtido no teste anterior esse teste pode esclarecer ainda mais o ajuste do modelo.   
O teste para avaliação da independência dos resíduos é utilizado para detectar a presença de autocorrelação provenientes de análise de regressão.  Realizando o teste obteve-se um valor de p-valor aproximadadente igual a `r round(t.dw[[4]][1],3)`, indicando que se deve rejeitar a hipotese que não existe correlação serial entre os dados, com uma confiança de 95%.



# Conclusão



# Referências

- Harrison, David & Rubinfeld, Daniel. (1978). Hedonic housing prices and the demand for clean air. Journal of Environmental Economics and Management. 5. 81-102. 10.1016/0095-0696(78)90006-2. 

- Belsley, David A. & Kuh, Edwin. & Welsch, Roy E. (1980). Regression diagnostics: identifying influential data and sources of collinearity. New York: Wiley.

